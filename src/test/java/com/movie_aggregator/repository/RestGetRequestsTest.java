package com.movie_aggregator.repository;

import com.movie_aggregator.AbstractTest;
import com.movie_aggregator.configuration.MyConfig;
import com.movie_aggregator.configuration.MyWebInitializer;
import com.movie_aggregator.testUtils.Database;
import org.junit.Test;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.extension.ExtendWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit.jupiter.SpringExtension;

import javax.ws.rs.client.*;
import javax.ws.rs.core.MediaType;
import static org.junit.jupiter.api.Assertions.assertEquals;
/**
 * @author mturchanov
 */
@ExtendWith(SpringExtension.class)
@ContextConfiguration(classes = { MyConfig.class, MyWebInitializer.class})
public class RestGetRequestsTest extends AbstractTest {

    @Autowired
    GenericDao dao;
    /**
     * Run set up tasks before each test:
     * 1. execute sql which deletes everything from the table and inserts records)
     * 2. Create any objects needed in the tests
     */
    @BeforeEach
    void setUp() {
        Database database = Database.getInstance();
        database.runSQL("cleandb.sql");
    }

    @Test
    public void testGetAllMoviesbySearch() throws Exception {
        Client client = ClientBuilder.newClient();
        WebTarget target =
                client.target("http://localhost:8080/yourindieproject_war/api/movies/s/Avengers/");
        String response = target.request(MediaType.APPLICATION_JSON).get(String.class);

        String expectedJSON = "[{\"id\":843649,\"name\":\"Avengers: Infinity War\",\"searches\":null,\"imdbId\":\"tt4154756\",\"kinopoiskId\":\"843649\",\"description\":\"The Avengers and their allies must be willing to sacrifice all in an attempt to defeat the powerful Thanos before his blitz of devastation and ruin puts an end to the universe.\",\"imdbRating\":\"8.4\",\"imdbVotes\":\"839,788\",\"metacriticRating\":\"68/100\",\"theMovieDbRating\":\"8.4/10\",\"rottenTomatoesRating\":\"85%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"Мстители: Война бесконечности\",\"kinopoiskRating\":\"7.9\",\"boxOffice\":\"$678,815,482\",\"duration\":\"2:29\",\"genre\":\"Action, Adventure, Sci-Fi\",\"director\":\"Anthony Russo, Joe Russo\",\"actors\":\"Robert Downey Jr., Chris Hemsworth, Mark Ruffalo, Chris Evans\",\"language\":\"English\",\"country\":\"USA\",\"metascore\":\"68\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/843649.jpg\",\"year\":\"2018\",\"kinopoiskVotes\":\"518805\"},{\"id\":843650,\"name\":\"Avengers: Endgame\",\"searches\":null,\"imdbId\":\"tt4154796\",\"kinopoiskId\":\"843650\",\"description\":\"After the devastating events of Avengers: Infinity War (2018), the universe is in ruins. With the help of remaining allies, the Avengers assemble once more in order to reverse Thanos' actions and restore balance to the universe.\",\"imdbRating\":\"8.4\",\"imdbVotes\":\"816,700\",\"metacriticRating\":\"78/100\",\"theMovieDbRating\":\"8.4/10\",\"rottenTomatoesRating\":\"94%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"Мстители: Финал\",\"kinopoiskRating\":\"7.6\",\"boxOffice\":\"$858,373,000\",\"duration\":\"3:01\",\"genre\":\"Action, Adventure, Drama, Sci-Fi\",\"director\":\"Anthony Russo, Joe Russo\",\"actors\":\"Robert Downey Jr., Chris Evans, Mark Ruffalo, Chris Hemsworth\",\"language\":\"English, Japanese, Xhosa, German\",\"country\":\"USA\",\"metascore\":\"78\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/843650.jpg\",\"year\":\"2019\",\"kinopoiskVotes\":\"439987\"}]";
        assertEquals(expectedJSON, response);
    }

    @Test
    public void testGetAllMovies() throws Exception {
        Client client = ClientBuilder.newClient();
        WebTarget target =
                client.target("http://localhost:8080/yourindieproject_war/api/movies/");
        String response = target.request(MediaType.APPLICATION_JSON).get(String.class);
        String expectedJSON = "[{\"id\":77394,\"name\":\"Django\",\"searches\":null,\"imdbId\":\"tt0060315\",\"kinopoiskId\":\"77394\",\"description\":\"In the opening scene a lone man walks, behind him he drags a coffin. That man is Django. He rescues a woman from bandits and, later, arrives in a town ravaged by the same bandits. The scene for confrontation is set. But why does he drag that coffin everywhere and who, or what, is in it?\",\"imdbRating\":\"7.2\",\"imdbVotes\":\"24,995\",\"metacriticRating\":\"75/100\",\"theMovieDbRating\":\"7.2/10\",\"rottenTomatoesRating\":\"92%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"Джанго\",\"kinopoiskRating\":\"7.5\",\"boxOffice\":\"$25,916\",\"duration\":\"1:31\",\"genre\":\"Action, Western\",\"director\":\"Sergio Corbucci\",\"actors\":\"Franco Nero, José Bódalo, Loredana Nusciak, Ángel Álvarez\",\"language\":\"Italian\",\"country\":\"Italy, Spain\",\"metascore\":\"75\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/77394.jpg\",\"year\":\"1966\",\"kinopoiskVotes\":\"6339\"},{\"id\":79817,\"name\":\"Django il bastardo\",\"searches\":null,\"imdbId\":\"tt0060315\",\"kinopoiskId\":\"79817\",\"description\":\"In the opening scene a lone man walks, behind him he drags a coffin. That man is Django. He rescues a woman from bandits and, later, arrives in a town ravaged by the same bandits. The scene for confrontation is set. But why does he drag that coffin everywhere and who, or what, is in it?\",\"imdbRating\":\"7.2\",\"imdbVotes\":\"24,995\",\"metacriticRating\":\"75/100\",\"theMovieDbRating\":\"7.2/10\",\"rottenTomatoesRating\":\"92%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"Ублюдок Джанго\",\"kinopoiskRating\":\"5.9\",\"boxOffice\":\"$25,916\",\"duration\":\"1:47\",\"genre\":\"Action, Western\",\"director\":\"Sergio Corbucci\",\"actors\":\"Franco Nero, José Bódalo, Loredana Nusciak, Ángel Álvarez\",\"language\":\"Italian\",\"country\":\"Italy, Spain\",\"metascore\":\"75\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/77394.jpg\",\"year\":\"1969\",\"kinopoiskVotes\":\"201\"},{\"id\":79900,\"name\":\"Pochi dollari per Django\",\"searches\":null,\"imdbId\":\"tt0060315\",\"kinopoiskId\":\"79900\",\"description\":\"In the opening scene a lone man walks, behind him he drags a coffin. That man is Django. He rescues a woman from bandits and, later, arrives in a town ravaged by the same bandits. The scene for confrontation is set. But why does he drag that coffin everywhere and who, or what, is in it?\",\"imdbRating\":\"7.2\",\"imdbVotes\":\"24,995\",\"metacriticRating\":\"75/100\",\"theMovieDbRating\":\"7.2/10\",\"rottenTomatoesRating\":\"92%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"Джанго, эта пуля для тебя!\",\"kinopoiskRating\":\"5.7\",\"boxOffice\":\"$25,916\",\"duration\":\"1:25\",\"genre\":\"Action, Western\",\"director\":\"Sergio Corbucci\",\"actors\":\"Franco Nero, José Bódalo, Loredana Nusciak, Ángel Álvarez\",\"language\":\"Italian\",\"country\":\"Italy, Spain\",\"metascore\":\"75\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/77394.jpg\",\"year\":\"1966\",\"kinopoiskVotes\":\"90\"},{\"id\":110902,\"name\":\"W Django!\",\"searches\":null,\"imdbId\":\"tt0060315\",\"kinopoiskId\":\"110902\",\"description\":\"In the opening scene a lone man walks, behind him he drags a coffin. That man is Django. He rescues a woman from bandits and, later, arrives in a town ravaged by the same bandits. The scene for confrontation is set. But why does he drag that coffin everywhere and who, or what, is in it?\",\"imdbRating\":\"7.2\",\"imdbVotes\":\"24,995\",\"metacriticRating\":\"75/100\",\"theMovieDbRating\":\"7.2/10\",\"rottenTomatoesRating\":\"92%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"Вива, Джанго!\",\"kinopoiskRating\":\"\",\"boxOffice\":\"$25,916\",\"duration\":\"1:30\",\"genre\":\"Action, Western\",\"director\":\"Sergio Corbucci\",\"actors\":\"Franco Nero, José Bódalo, Loredana Nusciak, Ángel Álvarez\",\"language\":\"Italian\",\"country\":\"Italy, Spain\",\"metascore\":\"75\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/77394.jpg\",\"year\":\"1971\",\"kinopoiskVotes\":\"n/a\"},{\"id\":267352,\"name\":\"Non aspettare Django, spara\",\"searches\":null,\"imdbId\":\"tt0060315\",\"kinopoiskId\":\"267352\",\"description\":\"In the opening scene a lone man walks, behind him he drags a coffin. That man is Django. He rescues a woman from bandits and, later, arrives in a town ravaged by the same bandits. The scene for confrontation is set. But why does he drag that coffin everywhere and who, or what, is in it?\",\"imdbRating\":\"7.2\",\"imdbVotes\":\"24,995\",\"metacriticRating\":\"75/100\",\"theMovieDbRating\":\"7.2/10\",\"rottenTomatoesRating\":\"92%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"Не медли, Джанго... Стреляй!\",\"kinopoiskRating\":\"\",\"boxOffice\":\"$25,916\",\"duration\":\"1:28\",\"genre\":\"Action, Western\",\"director\":\"Sergio Corbucci\",\"actors\":\"Franco Nero, José Bódalo, Loredana Nusciak, Ángel Álvarez\",\"language\":\"Italian\",\"country\":\"Italy, Spain\",\"metascore\":\"75\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/77394.jpg\",\"year\":\"1967\",\"kinopoiskVotes\":\"n/a\"},{\"id\":270561,\"name\":\"Django\",\"searches\":null,\"imdbId\":\"tt0060315\",\"kinopoiskId\":\"270561\",\"description\":\"In the opening scene a lone man walks, behind him he drags a coffin. That man is Django. He rescues a woman from bandits and, later, arrives in a town ravaged by the same bandits. The scene for confrontation is set. But why does he drag that coffin everywhere and who, or what, is in it?\",\"imdbRating\":\"7.2\",\"imdbVotes\":\"24,995\",\"metacriticRating\":\"75/100\",\"theMovieDbRating\":\"7.2/10\",\"rottenTomatoesRating\":\"92%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"\",\"kinopoiskRating\":\"\",\"boxOffice\":\"$25,916\",\"duration\":\"n/a\",\"genre\":\"Action, Western\",\"director\":\"Sergio Corbucci\",\"actors\":\"Franco Nero, José Bódalo, Loredana Nusciak, Ángel Álvarez\",\"language\":\"Italian\",\"country\":\"Italy, Spain\",\"metascore\":\"75\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/77394.jpg\",\"year\":\"1999\",\"kinopoiskVotes\":\"n/a\"},{\"id\":271836,\"name\":\"Sukiyaki Western Django\",\"searches\":null,\"imdbId\":\"tt0060315\",\"kinopoiskId\":\"271836\",\"description\":\"In the opening scene a lone man walks, behind him he drags a coffin. That man is Django. He rescues a woman from bandits and, later, arrives in a town ravaged by the same bandits. The scene for confrontation is set. But why does he drag that coffin everywhere and who, or what, is in it?\",\"imdbRating\":\"7.2\",\"imdbVotes\":\"24,995\",\"metacriticRating\":\"75/100\",\"theMovieDbRating\":\"7.2/10\",\"rottenTomatoesRating\":\"92%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"Сукияки Вестерн Джанго\",\"kinopoiskRating\":\"6.0\",\"boxOffice\":\"$25,916\",\"duration\":\"1:36\",\"genre\":\"Action, Western\",\"director\":\"Sergio Corbucci\",\"actors\":\"Franco Nero, José Bódalo, Loredana Nusciak, Ángel Álvarez\",\"language\":\"Italian\",\"country\":\"Italy, Spain\",\"metascore\":\"75\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/77394.jpg\",\"year\":\"2007\",\"kinopoiskVotes\":\"4092\"},{\"id\":586397,\"name\":\"Django Unchained\",\"searches\":null,\"imdbId\":\"tt0060315\",\"kinopoiskId\":\"586397\",\"description\":\"In the opening scene a lone man walks, behind him he drags a coffin. That man is Django. He rescues a woman from bandits and, later, arrives in a town ravaged by the same bandits. The scene for confrontation is set. But why does he drag that coffin everywhere and who, or what, is in it?\",\"imdbRating\":\"7.2\",\"imdbVotes\":\"24,995\",\"metacriticRating\":\"75/100\",\"theMovieDbRating\":\"7.2/10\",\"rottenTomatoesRating\":\"92%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"Джанго освобожденный\",\"kinopoiskRating\":\"8.2\",\"boxOffice\":\"$25,916\",\"duration\":\"2:45\",\"genre\":\"Action, Western\",\"director\":\"Sergio Corbucci\",\"actors\":\"Franco Nero, José Bódalo, Loredana Nusciak, Ángel Álvarez\",\"language\":\"Italian\",\"country\":\"Italy, Spain\",\"metascore\":\"75\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/77394.jpg\",\"year\":\"2012\",\"kinopoiskVotes\":\"455187\"},{\"id\":1008657,\"name\":\"Django\",\"searches\":null,\"imdbId\":\"tt0060315\",\"kinopoiskId\":\"1008657\",\"description\":\"In the opening scene a lone man walks, behind him he drags a coffin. That man is Django. He rescues a woman from bandits and, later, arrives in a town ravaged by the same bandits. The scene for confrontation is set. But why does he drag that coffin everywhere and who, or what, is in it?\",\"imdbRating\":\"7.2\",\"imdbVotes\":\"24,995\",\"metacriticRating\":\"75/100\",\"theMovieDbRating\":\"7.2/10\",\"rottenTomatoesRating\":\"92%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"Джанго\",\"kinopoiskRating\":\"5.9\",\"boxOffice\":\"$25,916\",\"duration\":\"1:57\",\"genre\":\"Action, Western\",\"director\":\"Sergio Corbucci\",\"actors\":\"Franco Nero, José Bódalo, Loredana Nusciak, Ángel Álvarez\",\"language\":\"Italian\",\"country\":\"Italy, Spain\",\"metascore\":\"75\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/77394.jpg\",\"year\":\"2017\",\"kinopoiskVotes\":\"130\"},{\"id\":1272234,\"name\":\"Django/Zorro\",\"searches\":null,\"imdbId\":\"tt0060315\",\"kinopoiskId\":\"1272234\",\"description\":\"In the opening scene a lone man walks, behind him he drags a coffin. That man is Django. He rescues a woman from bandits and, later, arrives in a town ravaged by the same bandits. The scene for confrontation is set. But why does he drag that coffin everywhere and who, or what, is in it?\",\"imdbRating\":\"7.2\",\"imdbVotes\":\"24,995\",\"metacriticRating\":\"75/100\",\"theMovieDbRating\":\"7.2/10\",\"rottenTomatoesRating\":\"92%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"\",\"kinopoiskRating\":\"97%\",\"boxOffice\":\"$25,916\",\"duration\":\"n/a\",\"genre\":\"Action, Western\",\"director\":\"Sergio Corbucci\",\"actors\":\"Franco Nero, José Bódalo, Loredana Nusciak, Ángel Álvarez\",\"language\":\"Italian\",\"country\":\"Italy, Spain\",\"metascore\":\"75\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/77394.jpg\",\"year\":\"2022\",\"kinopoiskVotes\":\"1142\"}]";
        assertEquals(expectedJSON, response);
    }

    @Test
    public void testGetMovieById() throws Exception {
        Client client = ClientBuilder.newClient();
        WebTarget target =
                client.target("http://localhost:8080/yourindieproject_war/api/movies/1272234/");
        String response = target.request(MediaType.APPLICATION_JSON).get(String.class);
        String expectedJSON = "{\"id\":1272234,\"name\":\"Django/Zorro\",\"searches\":null,\"imdbId\":\"tt0060315\",\"kinopoiskId\":\"1272234\",\"description\":\"In the opening scene a lone man walks, behind him he drags a coffin. That man is Django. He rescues a woman from bandits and, later, arrives in a town ravaged by the same bandits. The scene for confrontation is set. But why does he drag that coffin everywhere and who, or what, is in it?\",\"imdbRating\":\"7.2\",\"imdbVotes\":\"24,995\",\"metacriticRating\":\"75/100\",\"theMovieDbRating\":\"7.2/10\",\"rottenTomatoesRating\":\"92%\",\"tV_comRating\":null,\"filmAffinityRating\":null,\"easternName\":\"\",\"kinopoiskRating\":\"97%\",\"boxOffice\":\"$25,916\",\"duration\":\"n/a\",\"genre\":\"Action, Western\",\"director\":\"Sergio Corbucci\",\"actors\":\"Franco Nero, José Bódalo, Loredana Nusciak, Ángel Álvarez\",\"language\":\"Italian\",\"country\":\"Italy, Spain\",\"metascore\":\"75\",\"image\":\"https://kinopoiskapiunofficial.tech/images/posters/kp_small/77394.jpg\",\"year\":\"2022\",\"kinopoiskVotes\":\"1142\"}";
        assertEquals(expectedJSON, response);
    }
}
